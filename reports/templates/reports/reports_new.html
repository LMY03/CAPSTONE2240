<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.11.3/sorting/natural.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.11.3/sorting/percent.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }

        input[type="date"] {
            padding: 5px;
            width: 100%;
        }

        /* Charts */
        #myChart {
            margin-top: 20px;
            max-width: 95%;
            max-height: 400px;
            position: relative;
        }

        /* Forms */
        .clickable {
            background-color: #d96a00;
        }

        .clickable:hover {
            background-color: #d96a00;
        }

        .disable {
            background-color: gray; 
            color: white;
            cursor: not-allowed; 
            pointer-events: none; 
            opacity: 0.6; 
        }
    </style>

</head>

<body>
    <!-- Filter Conditions -->
    <div class="d-flex">
        
        <!-- Select Datetime -->
        <div class="w-50 p-4 m-4 border">
            <div class="d-flex justify-content-between">
                <div class="w-50">
                    <label class="d-flex fw-bolder" for="startDate">Start Date:</label>
                    <input class="form-control w-75" type="datetime-local" id="startDate">
                </div>
                <div class="w-50">
                    <label class="d-flex fw-bolder" for="endDate">End Date:</label>
                    <input class="form-control w-75" type="datetime-local" id="endDate">
                </div>
                <br>
                <div class="d-flex justify-content-end me-4">
                    <button type="button" class="btn" style="background-color: #d96a00;color: #fffafa;" onclick="show()">Filter</button>
                </div>
            </div>
        </div>

        <div class="w-50 p-4 m-4 d-flex justify-content-center align-items-center border">
            <div class="checkbox-group d-flex flex-column gap-2">
                <label class="d-flex fw-bolder">Metrics</label>
                <div class="d-flex gap-2">
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="cpu" onchange="updateChart()">cpu</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="cpu-us" onchange="updateChart()">cpu-us</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="mem" onchange="updateChart()">mem</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="mem-us" onchange="updateChart()">mem-us</label>
                </div>
                <div class="d-flex gap-2">
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="netin" onchange="updateChart()">netin</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="netout" onchange="updateChart()"> netout</label>  
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="storage" onchange="updateChart()">storage</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" value="storage-us" onchange="updateChart()">storage-us</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph -->
    <div class="position-relative">
        <button type="button" class="btn btn-sm position-absolute top-0 end-0 me-4" style="background-color: #d96a00;color: #fffafa;" onclick="exporeDataChart()">CSV</button>

        <div class="m-4 d-flex justify-content-center align-items-center">
            <canvas class="border" id="myChart"></canvas>
        </div>
    </div>
    <div class="position-relative mt-4"><button type="button" class="btn btn-sm position-absolute top-0 end-0 me-4" style="background-color: #d96a00;color: #fffafa;" onclick="exporeData()">CSV</button></div>

    <!-- Table 1 -->
    <div style="overflow-y:scroll;height:auto;width:98%;margin:1rem;overflow-x:hidden">
        <table id="VMtable" class="table display responsive" style="width:100%; margin: 1rem auto;">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Node</th>
                    <th>Subject</th>
                    <th>ID</th>
                    <th>VM Number</th>
                    <th>LXC Number</th>
                    <th>CPU</th>
                    <th>CPU Usage</th>
                    <th>RAM</th>
                    <th>RAM Usage</th>
                    <th>Storage</th>
                    <th>Storage Usage</th>
                    <th>Network In </th>
                    <th>Network Out </th>
                    <th>Uptime</th>
                </tr>
            </thead>
    
            <tbody id="vmstatus">
                
            </tbody>
        </table>
    </div>

    
    <script>
        const base_url = ""

        var table_data = []; //formdata
        var global_page = 1;

        var vmTable;

        // Define the order of columns as they appear in the table
        const columnOrder = [
            "Name", "Type", "Node", "Subject", "ID", "VM Number", "LXC Number", "CPU", 
            "CPU Usage", "RAM", "RAM Usage", "Storage", "Storage Usage", "Network In", 
            "Network Out", "Uptime"
        ];

        // Create a mapping between the table column names and the possible keys in tb_data
        const columnMapping = {
            "Name": ["name", "Name"],
            "Type": ["type", "Type"],
            "Node": ["nodename", "Node"],
            "Subject": ["class", "Subject"],
            "ID": ["vmid", "ID"],
            "VM Number": ["vm number", "VM Number"],
            "LXC Number": ["lxc number", "LXC Number"],
            "CPU": ["cpu", "CPU"],
            "CPU Usage": ["cpu usage", "CPU Usage"],
            "RAM": ["mem", "RAM"],
            "RAM Usage": ["mem usage", "RAM Usage"],
            "Storage": ["storage", "Storage"],
            "Storage Usage": ["storage usage", "Storage Usage"],
            "Network In": ["netin", "Network In"],
            "Network Out": ["netout", "Network Out"],
            "Uptime": ["uptime", "Uptime"]
        };
            

        function getTableData(start_time, end_time, page = 1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "start_time": start_time,
                    "end_time": end_time,
                    "page" : page
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/formdata?' + queryString;
                var fullUrl = 'formdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let data = xhr.response;
                        var current_page_sp = document.querySelector('#current_page');
                        current_page_sp.textContent = data.current_page;
                        global_page = data.current_page;
                        var page_count_sp = document.querySelector('#page_count');
                        page_count_sp.textContent = data.page_count;
                        if (data.current_page === data.page_count){
                            var next_page = document.querySelector("#nextPage");
                            next_page.classList.add("disable");
                            next_page.disable = true;
                        }
                        if (data.current_page === 1){
                            var pre_page = document.querySelector("#prePage");
                            pre_page.classList.add("disable");
                            pre_page.disable = true;
                        }
                        resolve(data.data);

                    } else {
                        reject(new Error("数据接口异常"));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败"));
                };

                xhr.send();
            });
        }

        function prevPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page-1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        };

        function nextPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page+1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        }

        function getChartData(start_time, end_time, _type = "system", name = "system", nodename = "none", _class =
            "none", vmid = -1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "type": _type,
                    "name": name,
                    "nodename": nodename,
                    "class": _class,
                    "vmid": vmid,
                    "start_time": start_time, 
                    "end_time": end_time
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/graphdata?' + queryString;
                var fullUrl = 'graphdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let label_data = {};
                        let data = xhr.response.data;
                        let x_labels = [];

                        data.forEach((element, index) => {
                            x_labels.push(data[index].time); // timestamp
                            let keys = Object.keys(element);
                            keys.forEach(e => {
                                if (e !== "time") {
                                    if (e in label_data) {
                                    label_data[e].push(element[e]); 
                                } else {
                                    label_data[e] = [element[e]]; 
                                }
                                }
                            });
                        });

                        let result_data = []; 
                        console.log("result_data in get chart data: ", result_data)
                        let keys = Object.keys(label_data);
                        keys.forEach(e => {
                            result_data.push({
                                label: e,
                                data: label_data[e],
                                // borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                            });
                        });

                        resolve({
                            x_labels,
                            result_data
                        }); 
                    } else {
                        reject(new Error("数据接口异常")); 
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败")); 
                };

                xhr.send(); 
            });
        }


        // 图表-start

        // 深拷贝一个
        var copy_data = {};
        
        var myChart = undefined;
        function showchart(labels, datasets, title = "system"){
            console.log("[title]: ", title)
            if (myChart === undefined){
                const data = {
                    labels: labels,
                    datasets : datasets
                }
                copy_data = JSON.parse(JSON.stringify(data))
                const cpuDataset = datasets.find(ds => ds.label === 'cpu usage') || datasets[0];
                const initialData = {
                    labels: labels,
                    datasets: [cpuDataset]
                };
                const config = {
                        type: 'line',
                        data: initialData,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title,
                                    font: {
                                        size: 20
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 30
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'time',
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'value',
                                    }
                                }
                            }
                        }
                    };
                myChart = new Chart(document.getElementById('myChart'),config);
            } else {
                const cpuDataset = datasets.find(ds => ds.label === 'cpu usage') || datasets[0];
                myChart.data.labels = labels;
                myChart.data.datasets = [cpuDataset];
                myChart.options.plugins.title.text = title;
                myChart.update();
            }

        };


        // update chart - filter
        function updateChart() {
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            const datasetsToShow = [];

            checkboxes.forEach((checkbox, index) => {
                const dataset = copy_data.datasets[index];
                console.log(index, dataset && checkbox.checked)

                // in dataset && metric being selected
                if (dataset && checkbox.checked) {
                    datasetsToShow.push(dataset);
                }
            });

            // if none being selected
            if (datasetsToShow.length === 0) {
                // use the fisrt one in dataset as default
                if (data.datasets.length > 0) {
                    datasetsToShow.push(data.datasets[0]);
                }
            }

            // 清空现有的数据集并添加选中的数据集
            myChart.data.datasets = datasetsToShow.map(dataset => {
                return {
                    ...dataset, // 浅拷贝现有数据集
                    data: [...dataset.data] // 确保数据是一个新的数组
                };
            });

            // 更新图表
            myChart.update();
        }

        // TODO: 默认只显示cpu-us的折线
        document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = checkbox.value === 'cpu-us';
        });
        
        // chart-end

        


        // form - start

        function showtable(tb_data) {
            // Select table
            let table = document.getElementById("VMtable2");
            let tbody = table.querySelector("tbody");
            let td_ls = Object.keys(tb_data[0]);
            console.log("td_ls: ", td_ls)
            let tr = table.querySelector("thead tr");
            tr.innerHTML = "";
            // let newCell1 = document.createElement("th");
            //             newCell1.textContent = "TYPE";
            //             tr.appendChild(newCell1);
            td_ls.forEach(td => {
                let newCell1 = document.createElement("th");
                newCell1.textContent = td;
                tr.appendChild(newCell1);
            });
            // 数据展示
            tbody.innerHTML = "";
            tb_data.forEach((element, index) => {
                let newrow = document.createElement("tr");
                td_ls.forEach(td => {
                    let newCell1 = document.createElement("td");
                    if (td == "name") {
                        newCell1.addEventListener("click", createClickHandler(index));
                        newCell1.className = "clickable"
                    }
                    newCell1.textContent = element[td];
                    newrow.appendChild(newCell1);
                });
                tbody.appendChild(newrow);

            })

        }

        function showtable2(tb_data) {

            vmTable = $('table#VMtable').DataTable({
                "pagingType": "simple_numbers",
                "autoWidth": "true",
                "responsive": "true",
                "select": "true",
                'columnDefs': [
                    { "type": "numeric", "targets": [5, 6, 7, 9, 11, 12, 14, 15] },
                    { "type": "percent", "targets": [8, 10, 12] },
                    // { className: "tdDiskUsage", "targets": [4] },
                    // { className: "tdMemoryUsage", "targets": [5] },
                    // { className: "tdCpuUsage", "targets": [6] },
                    // { className: "tdUptime", type: "natural", "targets": [9] }
                ]
            });

            // table content
            let vmInfo = []
            let metrics = Object.keys(tb_data[0]);
            tb_data.forEach(item => {
                let rowData = [];
                columnOrder.forEach(column => {
                    let value = null;
                    for (let key of columnMapping[column]) {
                        if (item.hasOwnProperty(key)) {
                            value = item[key];
                            break;
                        }
                    }
                    rowData.push(value);
                });
                vmInfo.push(rowData);
            });        
            // Now vmInfo contains the data in the correct order
            vmTable.clear().rows.add(vmInfo).draw();            
        }

        function getDateRange(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');
            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            return {startDate, endDate}
        };

        // 数据导出
        function exporeData() {
            const ws = XLSX.utils.json_to_sheet(table_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");
        }

        function exporeDataChart(){
            let chart_data = [];
            let labels = myChart.data.labels;
            console.log(labels);
            let dataset = myChart.data.datasets.reduce((acc, item) => {
                acc[item.label] = item.data; 
                return acc;
                }, {});
            
            console.log(Object.keys(dataset));
            labels.forEach((element,index)=>{
                chart_data.push({
                    "time" : element,
                    "cpu" :  dataset.cpu[index],
                    "cpu usage" : dataset["cpu usage"][index],
                    "mem" : dataset["mem"][index],
                    "mem usage" : dataset["mem usage"][index],
                    "netin" : dataset["netin" ][index],
                    "netout" : dataset[ 'netout'][index],
                    "storage" : dataset['storage'][index],
                    "storage usage" :dataset['storage'][index],
                })
            })
            const ws = XLSX.utils.json_to_sheet(chart_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");

        }

        // 表格 -end
        function show(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');

            if (!startDate_input.value || !endDate_input.value) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 480);
                const currentDateTime = now.toISOString().slice(0, 16);
                endDate_input.value = currentDateTime;
                now.setMinutes(now.getMinutes() - 1440);
                const pastOneDay = now.toISOString().slice(0, 16);
                startDate_input.value = pastOneDay
            };

            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            getTableData(startDate, endDate).then(tb_data=>{
                console.log("tb_table【show】",tb_data);
                // showtable(tb_data);
                showtable2(tb_data);
                table_data = tb_data;
            })
            getChartData(startDate, endDate).then(
                ({x_labels, result_data}) =>{
                    var labels, dataset;
                    console.log("chart_data【show】",x_labels,result_data)
                    showchart(x_labels,result_data);
                }
            );
        };
        show()

        function createClickHandler(index) {
            return function () {
                let row_data = table_data[index];
                let {startDate, endDate} = getDateRange();
                getChartData(startDate, endDate, row_data.type,
                    row_data.name, row_data.nodename, row_data.class, row_data.vmid)
                .then(({x_labels,result_data}) =>{
                    var labels,dataset;
                    console.log("【show】",x_labels,result_data)
                    showchart(x_labels,result_data, row_data.name);
                }
            );
            };
        }

    </script>

</body>

</html>