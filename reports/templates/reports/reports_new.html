<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #e1deded7;
        }

        .header {
            display: flex;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .time_filter {
            /* background-color: #fff; */
            padding: 20px;
            border-radius: 5px;
            float: left;
            width: 48%;
        }

        .term_filter {
            /* background-color: #fff; */
            padding: 20px;
            border-radius: 5px;
            /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */
            float: right;
            width: 48%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .controls {
            /* display: flex; */
            gap: 40px;
            align-items: center;
        }

        .date-inputs {
            display: flex;
            gap: 20px;
        }

        label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        input[type="date"] {
            padding: 5px;
            width: 100%;
        }

        button {
            padding: 10px 15px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #138496;
        }

        .result {
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-row {
            display: flex;
            gap: 20px;
        }

        .checkbox-group h3 {
            margin: 0;
            text-align: left;
        }

        /* Charts */
        #myChart {
            margin-top: 20px;
            max-width: 95%;
            max-height: 400px;
            position: relative;
        }

        .echat_img {
            position: relative;
        }

        .chart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .chart-button:hover {
            background-color: #138496;
        }

        /* Forms */
        .expore {
            position: relative;
            margin-top: 40px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #343a40;
            color: white;
            padding: 10px;
            text-align: left;
        }

        td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        .table-button {
            position: absolute;
            top: -20px;
            right: 10px;
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }

        .table-button:hover {
            background-color: #138496;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination button {
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        .clickable {
            background-color: #17a2b8;
        }

        .clickable:hover {
            background-color: #138496;
        }

        .disable {
            background-color: gray; 
            color: white; 
            cursor: not-allowed; 
            pointer-events: none; 
            opacity: 0.6;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>

<body>
    <div class="header">
        <div class="time_filter">
            <div class="controls">
                <div class="date-inputs">
                    <div style="width:50%">
                        <label for="startDate">Start Date:</label>
                        <input type="datetime-local" id="startDate">
                    </div>
                    <div style="width:50%">
                        <label for="endDate">End Date:</label>
                        <input type="datetime-local" id="endDate">
                    </div>
                </div>
                <br>
                <button onclick="show()">Filter</button>


            </div>

        </div>
        <div class="term_filter">
            <div class="checkbox-group">
                <h3>Metrics</h3>

                <div class="checkbox-row">
                    <!-- <label><input type="checkbox" value="选项1" onchange="updateChart()">time</label> -->
                    <label><input type="checkbox" value="cpu" onchange="updateChart()">cpu</label>
                    <label><input type="checkbox" value="cpu-us" onchange="updateChart()">cpu-us</label>
                    <label><input type="checkbox" value="mem" onchange="updateChart()">mem</label>

                </div>
                <div class="checkbox-row">
                    <label><input type="checkbox" value="mem-us" onchange="updateChart()">mem-us</label>
                    <label><input type="checkbox" value="storage" onchange="updateChart()">storage</label>
                    <label><input type="checkbox" value="storage-us" onchange="updateChart()">storage-us</label>
                    <label><input type="checkbox" value="netin" onchange="updateChart()">netin</label>

                </div>
                <div class="checkbox-row">
                    <label><input type="checkbox" value="netout" onchange="updateChart()"> netout</label>
                </div>
            </div>
        </div>
    </div>
    <div class="echat_img">
        <button class="chart-button" onclick="exportDataChart()">CSV</button>

        <canvas id="myChart"></canvas>
    </div>
    <div class="expore"><button class="table-button" onclick="exportData()">CSV</button></div>
    <div class="table-container">
        <!-- <button class="table-button" onclick="handleTableButtonClick()">CSV</button> -->
        <table>
            <thead>
                <tr>
                    <!-- vmid? -->
                    <th>TYPE</th>
                    <th>cpu</th>
                    <th>cpu usage</th>
                    <th>mem</th>
                    <th>mem usage</th>
                    <th>storage</th>
                    <th>storage usage</th>
                    <th>netin</th>
                    <th>netout</th>
                    <th>uptime</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <!-- <td>data 1.7</td> -->
                </tr>
            </tbody>
        </table>

        <!-- pagination -->
        <div class="pagination">
            <button id="prePage" onclick="prevPage()">Previous</button>
            <div>&ensp;<span id="current_page"></span>&ensp;/&ensp;<span id="page_count">&ensp;</span>&ensp;page(s)</div>
            <button id="nextPage" onclick="nextPage()">Next</button>
        </div>
    </div>
    <script>
        const base_url = ""

        var table_data = []; //formdata
        var global_page = 1;

        function getTableData(startDate, end_time,page=1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "start_time": startDate,
                    "end_time": end_time,
                    "page" : page
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/formdata?' + queryString;
                var fullUrl = 'formdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let data = xhr.response;
                        var current_page_sp = document.querySelector('#current_page');
                        current_page_sp.textContent = data.current_page;
                        global_page = data.current_page;
                        var page_count_sp = document.querySelector('#page_count');
                        page_count_sp.textContent = data.page_count;
                        if (data.current_page === data.page_count){
                            var next_page = document.querySelector("#nextPage");
                            next_page.classList.add("disable");
                            next_page.disable = true;
                        }
                        if (data.current_page === 1){
                            var pre_page = document.querySelector("#prePage");
                            pre_page.classList.add("disable");
                            pre_page.disable = true;
                        }
                        resolve(data.data);

                    } else {
                        reject(new Error("Data interface exception"));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("Request Failure"));
                };

                xhr.send();
            });
        }

        function prevPage(){
            let startDate,endDate;
            startDate,endDate = getDateRange();
            getTableData(startDate,endDate,global_page-1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        };

        function nextPage(){
            let startDate,endDate;
            startDate,endDate = getDateRange();
            getTableData(startDate,endDate,global_page+1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        }

        function getChartData(start_time, end_time, _type = "system", name = "system", nodename = "none", _class =
            "none", vmid = -1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "type": _type,
                    "name": name,
                    "nodename": nodename,
                    "class": _class,
                    "vmid": vmid,
                    "start_time": start_time, // 确保这里使用 start_time 参数
                    "end_time": end_time
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/graphdata?' + queryString;
                var fullUrl = 'graphdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let label_data = {};
                        let data = xhr.response.data;
                        let x_labels = [];
                        let title = xhr.response.name

                        data.forEach((element, index) => {
                            x_labels.push(data[index].time); // timestamp
                            let keys = Object.keys(element);
                            keys.forEach(e => {
                                if (e != "time") {
                                    if (e in label_data) {
                                        label_data[e].push(element[e]); // add if exist
                                    } else {
                                        label_data[e] = [element[e]]; // initialize if not exist
                                    }
                                }
                            });
                        });

                        let result_data = []; 
                        let keys = Object.keys(label_data);
                        keys.forEach(e => {
                            result_data.push({
                                label: e,
                                data: label_data[e],
                                // borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                            });
                        });

                        resolve({
                            x_labels,
                            result_data,
                            title
                        }); 
                    } else {
                        reject(new Error("Data interface exception"));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("Request Failure")); // Network Failure
                };

                xhr.send(); 
            });
        }


        // graph-start

        var copy_data = {};
        
        var myChart = undefined;
        function showchart(labels,datasets, title="system"){
            console.log("[title]", title)
            if (myChart === undefined){
                const data = {
                    labels: labels,
                    datasets : datasets
                }
                copy_data = JSON.parse(JSON.stringify(data))
                const config = {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title,
                                    font: {
                                        size: 20
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 30
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'time',
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'value',
                                    }
                                }
                            }
                        }
                    };
                myChart = new Chart(document.getElementById('myChart'),config);
                return
            };
            myChart.data.datasets = datasets;
            myChart.data.label = labels;
            myChart.update();
        };


        // update graph-filter
        function updateChart() {
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            const datasetsToShow = [];

            checkboxes.forEach((checkbox, index) => {
                const dataset = copy_data.datasets[index];

                // Ensure the dataset exists and the checkbox is selected
                if (dataset && checkbox.checked) {
                    datasetsToShow.push(dataset);
                }
            });

            // Handle the case when no checkbox is selected
            if (datasetsToShow.length === 0) {
                // If no checkbox is selected, use the first dataset as default.
                if (data.datasets.length > 0) {
                    datasetsToShow.push(data.datasets[0]);
                }
            }

            // Clear existing datasets and add the selected ones
            myChart.data.datasets = datasetsToShow.map(dataset => {
                return {
                    ...dataset, // Shallow copy of the existing dataset
                    data: [...dataset.data] // Ensure data is a new array
                };
            });

            // Update Chart
            myChart.update();
        }

        // 默认显示所有折线
        document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = true; 
        });
        
        // graph-end

        


        // form - start

        
        function showtable(tb_data) {
            // todo ajax request data
            let td_ls = Object.keys(tb_data[0]);
            let tr = document.querySelector("thead tr");
            tr.innerHTML = "";
            td_ls.forEach(td => {
                let newCell1 = document.createElement("th");
                newCell1.textContent = td;
                tr.appendChild(newCell1);
            });
            // show data
            let tbody = document.querySelector("tbody");
            tbody.innerHTML = "";
            tb_data.forEach((element, index) => {
                let newrow = document.createElement("tr");
                td_ls.forEach(td => {
                    let newCell1 = document.createElement("td");
                    if (td == "type") {
                        newCell1.addEventListener("click", createClickHandler(index));
                        newCell1.className = "clickable"
                    }
                    newCell1.textContent = element[td];
                    newrow.appendChild(newCell1);
                });
                tbody.appendChild(newrow);

            })

        }
        function getDateRange(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');
            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');
            return startDate,endDate
        };

        // export data
        function exportData() {
            const ws = XLSX.utils.json_to_sheet(table_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");
        }

        function exportDataChart(){
            let chart_data = [];
            let labels = myChart.data.labels;
            console.log(labels);
            let dataset = myChart.data.datasets.reduce((acc, item) => {
                acc[item.label] = item.data; 
                return acc;
                }, {});
            
            console.log(Object.keys(dataset));
            labels.forEach((element,index)=>{
                chart_data.push({
                    "time" : element,
                    "cpu" :  dataset.cpu[index],
                    "cpu usage" : dataset["cpu usage"][index],
                    "mem" : dataset["mem"][index],
                    "mem usage" : dataset["mem usage"][index],
                    "netin" : dataset["netin" ][index],
                    "netout" : dataset[ 'netout'][index],
                    "storage" : dataset['storage'][index],
                    "storage usage" :dataset['storage'][index],
                })
            })
            const ws = XLSX.utils.json_to_sheet(chart_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");

        }

        // form -end
        function show(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');

            if (!startDate_input.value || !endDate_input.value) {
                const now = new Date();
                const currentDateTime = now.toISOString().slice(0, 16);
                endDate_input.value = currentDateTime;
                // startDate_input.value = currentDateTime;
                now.setMinutes(now.getMinutes() - 1440);
                const pastOneday = now.toISOString().slice(0, 16);
                startDate_input.value = pastOneday;
                // endDate_input.value = pastOneday
            };

            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            getTableData(startDate,endDate).then(tb_data=>{
                console.log("【show】",tb_data);
                showtable(tb_data);
                table_data = tb_data;
            })
            getChartData(startDate,endDate).then(
                ({x_labels,result_data}) =>{
                    var labels,dataset;
                    console.log("【show】",x_labels,result_data)
                    showchart(x_labels,result_data,title);
                    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(e=>{
                        e.checked = false;
                    })
                    document.querySelectorAll('.checkbox-group input[type="checkbox"]')[0].checked = true;
                    updateChart();                    
                }
            );
        };
        show()

        function createClickHandler(index) {
            return function () {
                let row_data = table_data[index];
                datarange = getDateRange();
                getChartData(datarange.startDate,datarange.endDate,row_data.type,
                    row_data.name,row_data.nodename,row_data.class,row_data.vmid)
                .then(({x_labels,result_data}) =>{
                    var labels,dataset;
                    console.log("【show】",x_labels,result_data)
                    showchart(x_labels,result_data,title);
                }
            );
            };
        }

    </script>

</body>

</html>