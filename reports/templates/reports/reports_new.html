<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.11.3/sorting/natural.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.11.3/sorting/percent.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Ubuntu&display=swap');

        body {
            margin: 0px;
            padding: 0px;
            min-height: 100%;
            height: 100%;
            font-family: 'Ubuntu', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Baloo 2', sans-serif;
            font-weight: 600;
        }

        input[type="date"] {
            padding: 5px;
            width: 90%;
        }

        /* Charts */
        #myChart {
            max-width: 100%;
            max-height: 400px;
            position: relative;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .chart-container {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-container {
            background-color: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .btn-custom {
            background-color: #d96a00;
            color: #ffffff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .btn-custom:hover {
            background-color: #b85900;
        }

        /* Forms */
        .clickable {
            background-color: #d96a00;
        }

        .clickable:hover {
            background-color: #d96a00;
        }

        .disable {
            background-color: gray; 
            color: white;
            cursor: not-allowed; 
            pointer-events: none; 
            opacity: 0.6; 
        }

        .table-container {
            margin-left: auto;
            margin-right: auto;
        }

        #VMtable_length,
        #VMtable_filter,
        #VMtable_info,
        #vmInfoTable_length,
        #vmInfoTable_filter,
        #vmInfoTable_info {
            font-size: 1.1vw
        }

        th {
            font-size: 1.2vw;
            font-weight: bold;
            text-align: left;
        }

        td {
            font-size: 1.2vw;
        }

        #vminfo-div {
            min-height: 91vh;
            overflow: scroll;
            height: 100%;
            width: 100%;
            padding: 2rem 2rem 0rem 2rem;
            /* margin-top: 2rem; */
        }


        #VMtable tbody tr.selected {
            background-color: #b0bed9 !important;
        }

        #VMtable tbody tr:hover {
            background-color: #f5f5f5;
        }
    </style>

</head>

<body>
    <!-- Filter Conditions -->
    <div class="d-flex">
        
        <!-- Select Datetime -->
        <div class="w-50 px-2 py-2 m-2 border">
            <div class="d-flex justify-content-between">
                <div class="w-50">
                    <label class="d-flex fw-bolder" for="startDate">Start Date:</label>
                    <input class="form-control w-70" type="datetime-local" id="startDate">
                </div>
                <div class="w-50">
                    <label class="d-flex fw-bolder" for="endDate">End Date:</label>
                    <input class="form-control w-70" type="datetime-local" id="endDate">
                </div>
                <br>
                <div class="d-flex justify-content-end ms-2">
                    <button type="button" class="btn btn-sm" style="background-color: #d96a00;color: #fffafa; font-size: 0.8rem;" onclick="show()">Filter</button>
                </div>
            </div>
        </div>

        <div class="w-50 p-2 m-2 d-flex justify-content-center align-items-center border">
            <div class="radio-group d-flex flex-column gap-2">
                <div class="d-flex gap-4">
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="cpu" onchange="updateChart()">cpu</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="cpu usage" onchange="updateChart()">cpu usage</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="mem" onchange="updateChart()">mem</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="mem usage" onchange="updateChart()">mem usage</label>
                </div>
                <div class="d-flex gap-4">
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="storage" onchange="updateChart()">storage</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="storage usage" onchange="updateChart()">storage usage</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="netin" onchange="updateChart()">netin</label>
                    <label class="form-check-label"><input class="form-check-input me-1" type="radio" name="metric" value="netout" onchange="updateChart()">netout</label>  
                </div>
            </div>
        </div>
    </div>

    <!-- Graph -->
    <div class="position-relative">
        <button type="button" class="btn btn-sm position-absolute top-0 end-0 mt-4 me-4" style="background-color: #d96a00;color: #fffafa;" onclick="exporeDataChart()">CSV</button>

        <div class="m-2 d-flex justify-content-center align-items-center">
            <canvas class="border" id="myChart"></canvas>
        </div>
    </div>
    
    <!-- <div class="position-relative mt-4"><button type="button" class="btn btn-sm position-absolute top-0 end-0 me-4" style="background-color: #d96a00;color: #fffafa;" onclick="exporeData()">CSV</button></div> -->
    <!-- Table 1 -->
    <div class="table-container" style="overflow-y:scroll;height:auto;width:90%;overflow-x:auto">
        <table id="VMtable" class="table display responsive" style="width:100%; margin: 1rem auto;">
            <thead>
                <tr>
                    <!-- <th>ID</th>
                    <th>Type</th>
                    <th>Node</th>
                    <th>Subject</th>
                    <th>VM Number</th>
                    <th>LXC Number</th>
                    <th>Name</th>
                    <th>CPU</th>
                    <th>CPU Usage</th>
                    <th>RAM</th>
                    <th>RAM Usage</th>
                    <th>Storage</th>
                    <th>Storage Usage</th>
                    <th>Network In </th>
                    <th>Network Out </th>
                    <th>Uptime</th> -->
                </tr>
            </thead>
    
            <tbody id="vmstatus">
                
            </tbody>
        </table>
    </div>

    
    <script>
        const base_url = ""

        var table_data = []; //formdata
        var selected_metrics = [];
        var global_page = 1;

        var vmTable;

        // Define the order of columns as they appear in the table
        const columnOrder = [
            "Type", "Node", "Subject", "Name", "ID", "VM#", "LXC#", "CPU", 
            "CPU Usage(%)", "RAM(Gib)", "RAM Usage(%)", "Storage(Gib)", "Storage Usage(%)", 
            "Network In(K)", "Network Out(K)", "Uptime"
        ];

        // Create a mapping between the table column names and the possible keys in tb_data
        const columnMapping = {
            "Name": ["name", "Name"],
            "Type": ["type", "Type"],
            "Node": ["nodename", "Node"],
            "Subject": ["subject", "Subject"],
            "ID": ["vmid", "ID"],
            "VM#": ["vm number", "VM#"],
            "LXC#": ["lxc number", "LXC#"],
            "CPU": ["cpu", "CPU"],
            "CPU Usage(%)": ["cpu usage", "CPU Usage(%)"],
            "RAM(Gib)": ["mem", "RAM(Gib)"],
            "RAM Usage(%)": ["mem usage", "RAM Usage(%)"],
            "Storage(Gib)": ["storage", "Storage(Gib)"],
            "Storage Usage(%)": ["storage usage", "Storage Usage(%)"],
            "Network In(K)": ["netin", "Network In(K)"],
            "Network Out(K)": ["netout", "Network Out(K)"],
            "Uptime": ["uptime", "Uptime"]
        };
            

        function getTableData(start_time, end_time, page = 1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "start_time": start_time,
                    "end_time": end_time,
                    "page" : page
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/formdata?' + queryString;
                var fullUrl = 'formdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let data = xhr.response;
                        // var current_page_sp = document.querySelector('#current_page');
                        // current_page_sp.textContent = data.current_page;
                        // global_page = data.current_page;
                        // var page_count_sp = document.querySelector('#page_count');
                        // page_count_sp.textContent = data.page_count;
                        // if (data.current_page === data.page_count){
                        //     var next_page = document.querySelector("#nextPage");
                        //     next_page.classList.add("disable");
                        //     next_page.disable = true;
                        // }
                        // if (data.current_page === 1){
                        //     var pre_page = document.querySelector("#prePage");
                        //     pre_page.classList.add("disable");
                        //     pre_page.disable = true;
                        // }
                        resolve(data.data);

                    } else {
                        reject(new Error("数据接口异常"));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败"));
                };

                xhr.send();
            });
        }

        function prevPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page-1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        };

        function nextPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page+1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        }

        function getChartData(start_time, end_time, _type = "system", name = "system", nodename = "none", subject =
            "none", vmid = -1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "type": _type,
                    "name": name,
                    "nodename": nodename,
                    "subject": subject,
                    "vmid": vmid,
                    "start_time": start_time, 
                    "end_time": end_time
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/graphdata?' + queryString;
                var fullUrl = 'graphdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let label_data = {};
                        let data = xhr.response.data;
                        let x_labels = [];

                        data.forEach((element, index) => {
                            x_labels.push(data[index].time); // timestamp
                            let keys = Object.keys(element);
                            keys.forEach(e => {
                                if (e !== "time") {
                                    if (e in label_data) {
                                    label_data[e].push(element[e]); 
                                } else {
                                    label_data[e] = [element[e]]; 
                                }
                                }
                            });
                        });

                        let result_data = []; 
                        console.log("result_data in get chart data: ", result_data)
                        let keys = Object.keys(label_data);
                        keys.forEach(e => {
                            result_data.push({
                                label: e,
                                data: label_data[e],
                                // borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                            });
                        });

                        resolve({
                            x_labels,
                            result_data
                        }); 
                    } else {
                        reject(new Error("数据接口异常")); 
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败")); 
                };

                xhr.send(); 
            });
        }


        // 图表-start

        // 深拷贝一个
        var copy_data = {};
        
        var myChart = undefined;
        function showchart(labels, datasets, title = "system"){
            console.log("[title]: ", title)
            console.log("datasets: ", datasets)
            if (myChart === undefined){     // no chart yet
                const data = {
                    labels: labels,
                    datasets : datasets
                }
                copy_data = JSON.parse(JSON.stringify(data))
                const cpuDataset = datasets.find(ds => ds.label === 'cpu') || datasets[0];
                const initialData = {
                    labels: labels,
                    datasets: [cpuDataset]
                };
                const config = {
                        type: 'line',
                        data: initialData,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title,
                                    font: {
                                        size: 20,
                                        family: "'Baloo 2', sans-serif",
                                        weight: 'bold'                                        
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                legend: {
                                    position: 'top',
                                    labels: {
                                        font: {
                                            family: "'Ubuntu', sans-serif"
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                    titleColor: '#000',
                                    bodyColor: '#000',
                                    borderColor: '#d96a00',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time',
                                        font: {
                                            family: "'Ubuntu', sans-serif",
                                            size: 14
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: "'Ubuntu', sans-serif"
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Value',
                                        font: {
                                            family: "'Ubuntu', sans-serif",
                                            size: 14
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: "'Ubuntu', sans-serif"
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            elements: {
                                line: {
                                    tension: 0.3
                                },
                                point: {
                                    radius: 4,
                                    hoverRadius: 6
                                }
                            }
                        }
                    };
                myChart = new Chart(document.getElementById('myChart'),config);
            } else {            // mychart exists
                myChart.data.labels = labels;
                // get selected metrics
                const selectedMetric = getSelectedMetric();
                // filter database
                const selectedDataset = datasets.find(ds => ds.label === selectedMetric) || datasets[0];
                // filteredDatasets can be nothing
                myChart.data.datasets = [selectedDataset];
                myChart.options.plugins.title.text = title;
                myChart.update();

                // Store the new data for later use
                copy_data = {
                    labels: labels,
                    datasets: datasets
                };

                const initialMetric = datasets[0].label;
                document.querySelector(`input[type="radio"][value="${initialMetric}"]`).checked = true;
            }

        };

        // Helper function to get selected metric
        function getSelectedMetric() {
            const selectedRadio = document.querySelector('.radio-group input[type="radio"]:checked');
            return selectedRadio ? selectedRadio.value : null;
        }

        function updateChart() {
            const selectedMetric = getSelectedMetric();
            if (selectedMetric && copy_data && copy_data.datasets) {
                const dataset = copy_data.datasets.find(ds => ds.label === selectedMetric);
                if (dataset) {
                    myChart.data.datasets = [{
                        ...dataset,
                        borderColor: getRandomColor(),
                        backgroundColor: 'rgba(255, 255, 255, 0.1)'
                    }];
                    myChart.update();
                }
            }
            if (myChart) {
                myChart.update();
                updateTableHighlighting(vmTable);   
            }
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // default is cpu
        document.querySelector('.radio-group input[type="radio"][value="cpu"]').checked = true;

        
        // chart-end

        // form - start

        // function showtable(tb_data) {
        //     // Select table
        //     let table = document.getElementById("VMtable2");
        //     let tbody = table.querySelector("tbody");
        //     let td_ls = Object.keys(tb_data[0]);
        //     console.log("td_ls: ", td_ls)
        //     let tr = table.querySelector("thead tr");
        //     tr.innerHTML = "";
        //     // let newCell1 = document.createElement("th");
        //     //             newCell1.textContent = "TYPE";
        //     //             tr.appendChild(newCell1);
        //     td_ls.forEach(td => {
        //         let newCell1 = document.createElement("th");
        //         newCell1.textContent = td;
        //         tr.appendChild(newCell1);
        //     });
        //     // 数据展示
        //     tbody.innerHTML = "";
        //     tb_data.forEach((element, index) => {
        //         let newrow = document.createElement("tr");
        //         td_ls.forEach(td => {
        //             let newCell1 = document.createElement("td");
        //             if (td == "name") {
        //                 newCell1.addEventListener("click", createClickHandler(index));
        //                 newCell1.className = "clickable"
        //             }
        //             newCell1.textContent = element[td];
        //             newrow.appendChild(newCell1);
        //         });
        //         tbody.appendChild(newrow);

        //     })

        // }

        function showtable(tb_data) {
            // Store the original data for later use
            window.table_data = tb_data;

            // Define columns based on columnOrder and columnMapping
            let columns = columnOrder.map(columnName => {
                return {
                    data: function(row, type, val, meta) {
                        for (let key of columnMapping[columnName]) {
                            if (row.hasOwnProperty(key)) {
                                return row[key];
                            }
                        }
                        return null;
                    },
                    title: columnName
                }
            })

            // Check if DataTable already exists
            if ($.fn.DataTable.isDataTable('#VMtable')) {
                // Destroy the existing DataTable
                $('#VMtable').DataTable().destroy();
                // Clear the table content
                $('#VMtable').empty();
            }

            vmTable = $('table#VMtable').DataTable({
                data: tb_data,
                columns: columns,
                "pagingType": "simple_numbers",
                "autoWidth": false,
                "responsive": true,
                "select": true,
                'columnDefs': [
                    { "type": "numeric", "targets": [4, 5, 6, 7, 9, 11, 13, 14] },
                    { "type": "percent", "targets": [8, 10, 12] },
                    { className: "tdUptime", type: "natural", "targets": [15] }
                ],
                "rowCallback": function(row, data, index) {
                    if (data.type === 'system') {
                        $('td', row).css('background-color', '#e6f7ff');
                    } else if (data.type === 'node') {
                        $('td', row).css('background-color', '#fff1f0');
                    } else if (data.type === 'subject') {
                        $('td', row).css('background-color', '#f6ffed');
                    }
                },
                "drawCallback": function(settings) {
                    // Apply the cursor style to all rows after each draw
                    $('#VMtable tbody tr').css('cursor', 'pointer');
                    updateTableHighlighting(this.api());
                }
            });

            // Add click event listener to the entire table body
            $('#VMtable tbody').on('click', 'tr', function() {
                var data = vmTable.row(this).data();
                
                // Toggle selected class
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                } else {
                    vmTable.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }

                if (data) {  // Check if data exists (row is not empty)
                    let {startDate, endDate} = getDateRange();
                    getChartData(startDate, endDate, data.type, data.name, data.nodename, data.class, data.vmid)
                        .then(({x_labels, result_data}) => {
                            console.log("【show】", x_labels, result_data);
                            showchart(x_labels, result_data, data.name);
                            updateChart();
                        });
                }
            });

            // Apply the cursor style initially
            $('#VMtable tbody tr').css('cursor', 'pointer');
        }


        function getDateRange(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');
            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            return {startDate, endDate}
        };

        // 数据导出
        function exporeData() {
            const ws = XLSX.utils.json_to_sheet(table_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");
        }

        function exporeDataChart(){
            let chart_data = [];
            let labels = myChart.data.labels;
            console.log(labels);
            let dataset = myChart.data.datasets.reduce((acc, item) => {
                acc[item.label] = item.data; 
                return acc;
                }, {});
            
            console.log(Object.keys(dataset));
            labels.forEach((element,index)=>{
                chart_data.push({
                    "time" : element,
                    "cpu" :  dataset.cpu[index],
                    "cpu usage" : dataset["cpu usage"][index],
                    "mem" : dataset["mem"][index],
                    "mem usage" : dataset["mem usage"][index],
                    "netin" : dataset["netin" ][index],
                    "netout" : dataset[ 'netout'][index],
                    "storage" : dataset['storage'][index],
                    "storage usage" :dataset['storage'][index],
                })
            })
            const ws = XLSX.utils.json_to_sheet(chart_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");

        }

        // table -end
        function show(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');

            // get start date and end date
            if (!startDate_input.value || !endDate_input.value) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 480);
                const currentDateTime = now.toISOString().slice(0, 16);
                endDate_input.value = currentDateTime;
                now.setMinutes(now.getMinutes() - 1440);
                const pastOneDay = now.toISOString().slice(0, 16);
                startDate_input.value = pastOneDay
            };

            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            // get table data
            getTableData(startDate, endDate).then(tb_data=>{
                console.log("tb_table【show】",tb_data);
                // showtable(tb_data);
                showtable(tb_data);
                table_data = tb_data;
            })
            // get chart data
            getChartData(startDate, endDate).then(
                ({x_labels, result_data}) =>{
                    var labels, dataset;
                    console.log("chart_data【show】",x_labels,result_data)
                    showchart(x_labels,result_data);
                    updateChart();
                }
            );
        };
        show()

        // Function to set cell background color based on value and thresholds
        function setCellColor(cell, value, lowThreshold, midThreshold, highThreshold) {
            if (value > highThreshold) {
                $(cell).css('background-color', 'rgb(204, 0, 0, 0.5)');
                $(cell).css('border', '2.5px solid rgb(204,0,0)');
            } else if (value > midThreshold) {
                $(cell).css('background-color', 'rgb(259, 155, 0, 0.5)');
                $(cell).css('border', '2.5px solid rgb(239,155,0)');
            } else if (value > lowThreshold) {
                $(cell).css('background-color', 'rgb(253, 223, 46, 0.51)');
                $(cell).css('border', '2.5px solid rgb(232,204,39)');
            }
            // If value is 0 or below thresholds, we don't change the styling
        }

        // Function to update table highlighting
        function updateTableHighlighting(table) {
            table.rows().every(function(rowIdx, tableLoop, rowLoop) {
                var data = this.data();

                // CPU Usage (index 8)
                var cpuUsage = parseFloat(data['cpu usage']);
                console.log("cpu usage: ", cpuUsage)
                setCellColor(table.cell(rowIdx, 8).node(), cpuUsage, 25, 50, 75);

                // RAM Usage (index 10)
                var ramUsage = parseFloat(data['mem usage']);
                setCellColor(table.cell(rowIdx, 10).node(), ramUsage, 25, 50, 75);

                // Storage Usage (index 12)
                var storageUsage = parseFloat(data['storage usage']);
                setCellColor(table.cell(rowIdx, 12).node(), storageUsage, 25, 50, 75);
            });
        }

    </script>

</body>

</html>