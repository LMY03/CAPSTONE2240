<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #e1deded7;
        }

        .header {
            display: flex;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .time_filter {
            /* background-color: #fff; */
            padding: 20px;
            border-radius: 5px;
            float: left;
            width: 48%;
        }

        .term_filter {
            /* background-color: #fff; */
            padding: 20px;
            border-radius: 5px;
            /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */
            float: right;
            width: 48%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .controls {
            /* display: flex; */
            gap: 40px;
            align-items: center;
        }

        .date-inputs {
            display: flex;
            gap: 20px;
        }

        label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        input[type="date"] {
            padding: 5px;
            width: 100%;
        }

        button {
            padding: 10px 15px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #138496;
        }

        .result {
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-row {
            display: flex;
            gap: 20px;
        }

        .checkbox-group h3 {
            margin: 0;
            text-align: left;
        }

        /* Charts */
        #myChart {
            margin-top: 20px;
            max-width: 95%;
            max-height: 400px;
            position: relative;
        }

        .echat_img {
            position: relative;
        }

        .chart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .chart-button:hover {
            background-color: #138496;
        }

        /* Forms */
        .expore {
            position: relative;
            margin-top: 40px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
            /* position: relative; 允许绝对定位按钮 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #343a40;
            color: white;
            padding: 10px;
            text-align: left;
        }

        td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        .table-button {
            position: absolute;
            top: -20px;
            right: 10px;
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }

        .table-button:hover {
            background-color: #138496;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination button {
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        .clickable {
            background-color: #17a2b8;
        }

        .clickable:hover {
            background-color: #138496;
        }

        .disable {
            background-color: gray; /* 灰色背景 */
            color: white; /* 白色文字 */
            cursor: not-allowed; /* 禁用手势 */
            pointer-events: none; /* 禁止点击 */
            opacity: 0.6; /* 半透明 */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>

<body>
    <div class="header">
        <!-- <h4 style="text-align: center;">条件筛选</h4> -->
        <div class="time_filter">
            <div class="controls">
                <div class="date-inputs">
                    <div style="width:50%">
                        <label for="startDate">Start Date:</label>
                        <input type="datetime-local" id="startDate">
                    </div>
                    <div style="width:50%">
                        <label for="endDate">End Date:</label>
                        <input type="datetime-local" id="endDate">
                    </div>
                </div>
                <br>
                <button onclick="show()">Filter</button>


            </div>

        </div>
        <div class="term_filter">
            <div class="checkbox-group">
                <h3>Metrics</h3>

                <div class="checkbox-row">
                    <label><input type="checkbox" value="cpu" onchange="updateChart()">cpu</label>
                    <label><input type="checkbox" value="cpu-us" onchange="updateChart()">cpu-us</label>
                    <label><input type="checkbox" value="mem" onchange="updateChart()">mem</label>

                </div>
                <div class="checkbox-row">
                    <label><input type="checkbox" value="mem-us" onchange="updateChart()">mem-us</label>
                    <label><input type="checkbox" value="storage" onchange="updateChart()">storage</label>
                    <label><input type="checkbox" value="storage-us" onchange="updateChart()">storage-us</label>
                    <label><input type="checkbox" value="netin" onchange="updateChart()">netin</label>

                </div>
                <div class="checkbox-row">
                    <label><input type="checkbox" value="netout" onchange="updateChart()"> netout</label>                </div>
            </div>
        </div>
    </div>
    <div class="echat_img">
        <button class="chart-button" onclick="exporeDataChart()">CSV</button>

        <canvas id="myChart"></canvas>
    </div>
    <div class="expore"><button class="table-button" onclick="exporeData()">CSV</button></div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>TYPE</th>
                    <th>cpu</th>
                    <th>cpu usage</th>
                    <th>mem</th>
                    <th>mem usage</th>
                    <th>storage</th>
                    <th>storage usage</th>
                    <th>netin</th>
                    <th>netout</th>
                    <th>uptime</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <!-- <td>Data 1.7</td> -->
                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
            <button id="prePage" onclick="prevPage()">Prev</button>
            <div>&ensp;<span id="current_page"></span>&ensp; / &ensp;<span id="page_count">&ensp;</span>&ensp;</div>
            <button id="nextPage" onclick="nextPage()">Next</button>
        </div>
    </div>
    <script>
        const base_url = ""

        var table_data = []; //formdata
        var global_page = 1;

        function getTableData(start_time, end_time, page = 1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "start_time": start_time,
                    "end_time": end_time,
                    "page" : page
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/formdata?' + queryString;
                var fullUrl = 'formdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let data = xhr.response;
                        var current_page_sp = document.querySelector('#current_page');
                        current_page_sp.textContent = data.current_page;
                        global_page = data.current_page;
                        var page_count_sp = document.querySelector('#page_count');
                        page_count_sp.textContent = data.page_count;
                        if (data.current_page === data.page_count){
                            var next_page = document.querySelector("#nextPage");
                            next_page.classList.add("disable");
                            next_page.disable = true;
                        }
                        if (data.current_page === 1){
                            var pre_page = document.querySelector("#prePage");
                            pre_page.classList.add("disable");
                            pre_page.disable = true;
                        }
                        resolve(data.data);

                    } else {
                        reject(new Error("数据接口异常"));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败"));
                };

                xhr.send();
            });
        }

        function prevPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page-1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        };

        function nextPage(){
            let {startDate, endDate} = getDateRange();
            getTableData(startDate,endDate,global_page+1).then(tb_data=>{
                showtable(tb_data);
                table_data = tb_data;
            })
        }

        function getChartData(start_time, end_time, _type = "system", name = "system", nodename = "none", _class =
            "none", vmid = -1) {
            return new Promise((resolve, reject) => {
                var params = {
                    "type": _type,
                    "name": name,
                    "nodename": nodename,
                    "class": _class,
                    "vmid": vmid,
                    "start_time": start_time, 
                    "end_time": end_time
                };

                var xhr = new XMLHttpRequest();
                var queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                // var fullUrl = base_url + '/reports/graphdata?' + queryString;
                var fullUrl = 'graphdata?' + queryString;

                xhr.open('GET', fullUrl, true);
                xhr.responseType = 'json';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        let label_data = {};
                        let data = xhr.response.data;
                        let x_labels = [];

                        data.forEach((element, index) => {
                            x_labels.push(data[index].time); // timestamp
                            let keys = Object.keys(element);
                            keys.forEach(e => {
                                if (e !== "time") {
                                    if (e in label_data) {
                                    label_data[e].push(element[e]); 
                                } else {
                                    label_data[e] = [element[e]]; 
                                }
                                }
                            });
                        });

                        let result_data = []; 
                        console.log("result_data in get chart data: ", result_data)
                        let keys = Object.keys(label_data);
                        keys.forEach(e => {
                            result_data.push({
                                label: e,
                                data: label_data[e],
                                // borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                            });
                        });

                        resolve({
                            x_labels,
                            result_data
                        }); 
                    } else {
                        reject(new Error("数据接口异常")); 
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("请求失败")); 
                };

                xhr.send(); 
            });
        }


        // 图表-start

        // 深拷贝一个
        var copy_data = {};
        
        var myChart = undefined;
        function showchart(labels, datasets, title="system"){
            console.log("[title]: ", title)
            if (myChart === undefined){
                const data = {
                    labels: labels,
                    datasets : datasets
                }
                copy_data = JSON.parse(JSON.stringify(data))
                const config = {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title,
                                    font: {
                                        size: 20
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 30
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'time',
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'value',
                                    }
                                }
                            }
                        }
                    };
                myChart = new Chart(document.getElementById('myChart'),config);
                return
            };
            myChart.data.datasets = datasets;
            myChart.data.label = labels;
            myChart.options.plugins.title.text = title;
            myChart.update();
        };


        // 更新图表显示-筛选
        function updateChart() {
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            const datasetsToShow = [];

            checkboxes.forEach((checkbox, index) => {
                const dataset = copy_data.datasets[index];
                console.log(index, dataset && checkbox.checked)

                // 确保数据集存在并且复选框被选中
                if (dataset && checkbox.checked) {
                    datasetsToShow.push(dataset);
                }
            });

            // 处理没有选中复选框的情况
            if (datasetsToShow.length === 0) {
                // 如果没有复选框选中，给出默认的数据集（选择第一个数据集作为默认）
                if (data.datasets.length > 0) {
                    datasetsToShow.push(data.datasets[0]);
                }
            }

            // 清空现有的数据集并添加选中的数据集
            myChart.data.datasets = datasetsToShow.map(dataset => {
                return {
                    ...dataset, // 浅拷贝现有数据集
                    data: [...dataset.data] // 确保数据是一个新的数组
                };
            });

            // 更新图表
            myChart.update();
        }

        // 默认显示所有折线
        document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = true; // 默认勾选所有复选框
        });
        
        // 图表-end

        


        // 表格 - start

        
        function showtable(tb_data) {
            // todo ajax请求获取数据
            let td_ls = Object.keys(tb_data[0]);
            let tr = document.querySelector("thead tr");
            tr.innerHTML = "";
            // let newCell1 = document.createElement("th");
            //             newCell1.textContent = "TYPE";
            //             tr.appendChild(newCell1);
            td_ls.forEach(td => {
                let newCell1 = document.createElement("th");
                newCell1.textContent = td;
                tr.appendChild(newCell1);
            });
            // 数据展示
            let tbody = document.querySelector("tbody");
            tbody.innerHTML = "";
            tb_data.forEach((element, index) => {
                let newrow = document.createElement("tr");
                td_ls.forEach(td => {
                    let newCell1 = document.createElement("td");
                    if (td == "type") {
                        newCell1.addEventListener("click", createClickHandler(index));
                        newCell1.className = "clickable"
                    }
                    newCell1.textContent = element[td];
                    newrow.appendChild(newCell1);
                });
                tbody.appendChild(newrow);

            })

        }
        function getDateRange(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');
            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            return {startDate, endDate}
        };

        // 数据导出
        function exporeData() {
            const ws = XLSX.utils.json_to_sheet(table_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");
        }

        function exporeDataChart(){
            let chart_data = [];
            let labels = myChart.data.labels;
            console.log(labels);
            let dataset = myChart.data.datasets.reduce((acc, item) => {
                acc[item.label] = item.data; 
                return acc;
                }, {});
            
            console.log(Object.keys(dataset));
            labels.forEach((element,index)=>{
                chart_data.push({
                    "time" : element,
                    "cpu" :  dataset.cpu[index],
                    "cpu usage" : dataset["cpu usage"][index],
                    "mem" : dataset["mem"][index],
                    "mem usage" : dataset["mem usage"][index],
                    "netin" : dataset["netin" ][index],
                    "netout" : dataset[ 'netout'][index],
                    "storage" : dataset['storage'][index],
                    "storage usage" :dataset['storage'][index],
                })
            })
            const ws = XLSX.utils.json_to_sheet(chart_data);
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "data.xlsx");

        }

        // 表格 -end
        function show(){
            const startDate_input = document.getElementById('startDate');
            const endDate_input = document.getElementById('endDate');

            if (!startDate_input.value || !endDate_input.value) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 480);
                const currentDateTime = now.toISOString().slice(0, 16);
                endDate_input.value = currentDateTime;
                now.setMinutes(now.getMinutes() - 1440);
                const pastOneDay = now.toISOString().slice(0, 16);
                startDate_input.value = pastOneDay
            };

            const date = new Date(startDate_input.value);
            const startDate = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');

            const date_str = new Date(endDate_input.value);
            const endDate = date_str.getFullYear() + '-' +
                String(date_str.getMonth() + 1).padStart(2, '0') + '-' +
                String(date_str.getDate()).padStart(2, '0') + ' ' +
                String(date_str.getHours()).padStart(2, '0') + ':' +
                String(date_str.getMinutes()).padStart(2, '0') + ':' +
                String(date_str.getSeconds()).padStart(2, '0');

            getTableData(startDate, endDate).then(tb_data=>{
                console.log("【show】",tb_data);
                showtable(tb_data);
                table_data = tb_data;
            })
            getChartData(startDate, endDate).then(
                ({x_labels, result_data}) =>{
                    var labels, dataset;
                    console.log("【show】",x_labels,result_data)
                    showchart(x_labels,result_data);
                }
            );
        };
        show()

        function createClickHandler(index) {
            return function () {
                let row_data = table_data[index];
                let {startDate, endDate} = getDateRange();
                getChartData(startDate, endDate, row_data.type,
                    row_data.name, row_data.nodename, row_data.class, row_data.vmid)
                .then(({x_labels,result_data}) =>{
                    var labels,dataset;
                    console.log("【show】",x_labels,result_data)
                    showchart(x_labels,result_data, row_data.name);
                }
            );
            };
        }

    </script>

</body>

</html>